"""Exceptions for Broadlink devices."""
import struct


class BroadlinkException(Exception):
    """Common base class for all Broadlink exceptions."""

    def __init__(self, *args, **kwargs):
        """Initialize the exception."""
        super().__init__(*args, **kwargs)
        if len(args) >= 3:
            self.errno = args[0]
            self.strerror = "%s: %s" % (args[1], args[2])
        elif len(args) == 2:
            self.errno = args[0]
            self.strerror = str(args[1])
        elif len(args) == 1:
            self.errno = None
            self.strerror = str(args[0])
        else:
            self.errno = None
            self.strerror = ""

    def __str__(self):
        """Return the error message."""
        if self.errno is not None:
            return "[Errno %s] %s" % (self.errno, self.strerror)
        return self.strerror


class FirmwareException(BroadlinkException):
    """Base class common to all firmware exceptions."""


class AuthenticationError(FirmwareException):
    """Authentication error."""


class AuthorizationError(FirmwareException):
    """Authorization error."""


class CommandNotSupportedError(FirmwareException):
    """Command not supported error."""


class ConnectionClosedError(FirmwareException):
    """Connection closed error."""


class StructureAbnormalError(FirmwareException):
    """Structure abnormal error."""


class DeviceOfflineError(FirmwareException):
    """Device offline error."""


class ReadError(FirmwareException):
    """Read error."""


class SendError(FirmwareException):
    """Send error."""


class SSIDNotFoundError(FirmwareException):
    """SSID not found error."""


class StorageError(FirmwareException):
    """Storage error."""


class WriteError(FirmwareException):
    """Write error."""


class SDKException(BroadlinkException):
    """Base class common to all SDK exceptions."""


class DataValidationError(SDKException, ValueError):
    """Class common to all SDK value errors."""


class NetworkTimeoutError(SDKException):
    """Network timeout error."""


class UnknownError(BroadlinkException):
    """Unknown error."""


BROADLINK_EXCEPTIONS = {
    # Firmware-related errors are generated by the device.
    -1: (AuthenticationError, "Authentication failed"),
    -2: (ConnectionClosedError, "You have been logged out"),
    -3: (DeviceOfflineError, "The device is offline"),
    -4: (CommandNotSupportedError, "Command not supported"),
    -5: (StorageError, "The device storage is full"),
    -6: (StructureAbnormalError, "Structure is abnormal"),
    -7: (AuthorizationError, "Control key is expired"),
    -8: (SendError, "Send error"),
    -9: (WriteError, "Write error"),
    -10: (ReadError, "Read error"),
    -11: (SSIDNotFoundError, "SSID could not be found in AP configuration"),
    # SDK related errors are generated by this module.
    -2040: (DataValidationError, "Device information is not intact"),
    -4000: (NetworkTimeoutError, "Network timeout"),
    -4007: (DataValidationError, "Received data packet length error"),
    -4008: (DataValidationError, "Received data packet check error"),
    -4009: (DataValidationError, "Received data packet information type error"),
    -4010: (DataValidationError, "Received encrypted data packet length error"),
    -4011: (DataValidationError, "Received encrypted data packet check error"),
    -4026: (DataValidationError, "Data sent or received error"),
}


def exception(error_code: int, *error_msg: str):
    """Return exception corresponding to an error code."""
    try:
        exc, msg = BROADLINK_EXCEPTIONS[error_code]
    except KeyError:
        exc, msg = UnknownError, "Unknown error"

    if error_msg:
        return exc(error_code, *error_msg)
    return exc(error_code, msg)


def check_error(error):
    """Raise exception if an error occurred."""
    error_code = struct.unpack("h", error)[0]
    if error_code:
        raise exception(error_code)
